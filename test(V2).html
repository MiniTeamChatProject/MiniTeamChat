<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniChat ç®€æ˜“ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- å¤´éƒ¨çŠ¶æ€æ  -->
        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">ğŸ’¬ MiniChat é¢æ¿</h1>
            <div id="userStatus">
                <span class="text-gray-500">æœªç™»å½•</span>
            </div>
        </div>

        <!-- ç™»å½•åŒºåŸŸ (ç™»å½•åéšè—) -->
        <div id="loginSection" class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-4">ğŸ”‘ ç™»å½•</h2>
            <div class="flex gap-4">
                <input type="email" id="email" value="student_01@example.com" class="border p-2 rounded w-64" placeholder="é‚®ç®±">
                <input type="password" id="pwd" value="123456" class="border p-2 rounded w-48" placeholder="å¯†ç ">
                <button onclick="login()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">ç™»å½•</button>
            </div>
            <p id="loginMsg" class="mt-2 text-sm text-red-500"></p>
        </div>

        <!-- æˆ¿é—´åŒºåŸŸ (ç™»å½•å‰éšè—) -->
        <div id="roomSection" class="hidden space-y-6">
            
            <!-- åˆ›å»ºæˆ¿é—´ -->
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                <h2 class="text-lg font-bold mb-4">ğŸ  åˆ›å»ºæ–°æˆ¿é—´</h2>
                <div class="flex gap-4">
                    <input type="text" id="roomName" class="border p-2 rounded w-64" placeholder="è¾“å…¥æˆ¿é—´å (ä¾‹å¦‚: å‰ç«¯æ‘¸é±¼ç¾¤)">
                    <button onclick="createRoom()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">åˆ›å»º</button>
                </div>
            </div>

            <!-- æˆ¿é—´åˆ—è¡¨ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“‹ æˆ¿é—´åˆ—è¡¨</h2>
                    <button onclick="loadRooms()" class="text-blue-600 text-sm hover:underline">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div id="roomList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- æˆ¿é—´å¡ç‰‡ä¼šæ’åœ¨è¿™é‡Œ -->
                    <p class="text-gray-400">æš‚æ— æˆ¿é—´...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const USER_API = "http://localhost:8081";
        const ROOM_API = "http://localhost:8082";
        let token = localStorage.getItem("token");
        let username = localStorage.getItem("username");

        // åˆå§‹åŒ–æ£€æŸ¥
        if (token) {
            showLoggedIn();
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pwd').value;
            
            try {
                const res = await fetch(`${USER_API}/login`, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                
                if (res.ok) {
                    token = data.token;
                    username = data.username;
                    localStorage.setItem("token", token);
                    localStorage.setItem("username", username);
                    showLoggedIn();
                    document.getElementById('loginMsg').innerText = "";
                } else {
                    document.getElementById('loginMsg').innerText = "ç™»å½•å¤±è´¥: " + data.error;
                }
            } catch (e) {
                alert("æ— æ³•è¿æ¥ç”¨æˆ·æœåŠ¡ï¼Œè¯·æ£€æŸ¥ 8081 ç«¯å£");
            }
        }

        function showLoggedIn() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('roomSection').classList.remove('hidden');
            document.getElementById('userStatus').innerHTML = `
                <span class="font-bold text-blue-600 mr-2">${username}</span>
                <button onclick="logout()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">é€€å‡º</button>
            `;
            loadRooms();
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        async function createRoom() {
            const name = document.getElementById('roomName').value;
            if (!name) return alert("è¯·è¾“å…¥æˆ¿é—´å");

            try {
                const res = await fetch(`${ROOM_API}/rooms`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}` // å…³é”®ï¼šå¸¦ä¸Š Token
                    },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    document.getElementById('roomName').value = "";
                    loadRooms(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert("åˆ›å»ºå¤±è´¥ (å¯èƒ½æ˜¯ Token è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•)");
                }
            } catch (e) {
                alert("æ— æ³•è¿æ¥æˆ¿é—´æœåŠ¡ï¼Œè¯·æ£€æŸ¥ 8082 ç«¯å£");
            }
        }

        async function loadRooms() {
            try {
                const res = await fetch(`${ROOM_API}/rooms`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const list = document.getElementById('roomList');
                
                if (data.rooms && data.rooms.length > 0) {
                    list.innerHTML = data.rooms.map(room => `
                        <div class="border p-4 rounded hover:bg-blue-50 transition cursor-pointer flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${room.name}</h3>
                                <p class="text-xs text-gray-500">ID: ${room.id}</p>
                            </div>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">è¿›å…¥</span>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = `<p class="text-gray-400 col-span-2 text-center py-4">è¿˜æ²¡æœ‰æˆ¿é—´ï¼Œå¿«åˆ›å»ºä¸€ä¸ªå§ï¼</p>`;
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>